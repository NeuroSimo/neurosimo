---
- name: Install Docker Engine and Docker Compose Plugin on Ubuntu 22.04
  hosts: all
  become: yes
  connection: local

  vars:
    docker_keyring_path: /etc/apt/keyrings/docker.gpg
    docker_repo_url: https://download.docker.com/linux/ubuntu
    docker_repo_file: /etc/apt/sources.list.d/docker.list
    target_user: "{{ lookup('env', 'SUDO_USER') | default(lookup('env','USER'), true) }}"
    enable_docker_compose_legacy_alias: true

  tasks:
    # -------------------------------------------------------------------------
    # 0) Guardrails / sanity checks
    # -------------------------------------------------------------------------
    - name: Assert Ubuntu 22.04 / jammy
      assert:
        that:
          - ansible_distribution == "Ubuntu"
          - ansible_distribution_release == "jammy"
        fail_msg: "This playbook is intended for Ubuntu 22.04 (jammy). Detected {{ ansible_distribution }} {{ ansible_distribution_release }}"

    # -------------------------------------------------------------------------
    # 1) Install prerequisites
    # -------------------------------------------------------------------------
    - name: Ensure prerequisites are installed
      apt:
        name:
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present

    # -------------------------------------------------------------------------
    # 2) Docker repo hygiene: remove legacy/conflicting Docker source definitions
    # -------------------------------------------------------------------------
    - name: Remove legacy Docker apt source files
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/apt/sources.list.d/docker.list
        - /etc/apt/sources.list.d/docker-ce.list
        - /etc/apt/sources.list.d/docker-engine.list
      ignore_errors: true

    - name: Remove any Docker repo lines from main sources.list
      lineinfile:
        path: /etc/apt/sources.list
        regexp: '.*download\.docker\.com/linux/ubuntu.*'
        state: absent
      ignore_errors: true

    - name: Ensure directory for APT keyrings exists
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'


    # ------------------------------------------------------------------------
    # 3) Install Docker GPG key deterministically
    # -------------------------------------------------------------------------
    - name: Install Docker GPG key
      shell: |
        set -euo pipefail
        curl -fsSL "{{ docker_repo_url }}/gpg" \
          | gpg --batch --yes --dearmor -o "{{ docker_keyring_path }}"
        chmod 0644 "{{ docker_keyring_path }}"
      args:
        executable: /bin/bash

    # -------------------------------------------------------------------------
    # 4) Write canonical Docker repo file
    # -------------------------------------------------------------------------
    - name: Configure Docker apt repository
      copy:
        dest: "{{ docker_repo_file }}"
        mode: '0644'
        content: |
          deb [arch=amd64 signed-by={{ docker_keyring_path }}] {{ docker_repo_url }} {{ ansible_lsb.codename }} stable

    # -------------------------------------------------------------------------
    # 5) Update cache
    # -------------------------------------------------------------------------
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    # -------------------------------------------------------------------------
    # 6) Install Docker packages
    # -------------------------------------------------------------------------
    - name: Install Docker packages
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present

    # -------------------------------------------------------------------------
    # 7) Ensure user is in docker group
    # -------------------------------------------------------------------------
    - name: Ensure docker group exists
      group:
        name: docker
        state: present

    - name: Add user to docker group
      user:
        name: "{{ target_user }}"
        groups: docker
        append: yes

    # -------------------------------------------------------------------------
    # 8) Enable and start service
    # -------------------------------------------------------------------------
    - name: Ensure Docker service is enabled and started
      service:
        name: docker
        enabled: yes
        state: started
