#!/bin/bash
set -euo pipefail

# Usage examples:
# ./log [service_name] --from "YYYY-MM-DD HH:MM:SS" --to "YYYY-MM-DD HH:MM:SS"
# ./log [service_name] --last-hour
# ./log [service_name] --save output.log
# ./log [service_name] -n 50

CONTAINER_NAME=""
FROM=""
TO=""
FOLLOW=true          # Default to follow mode
SAVE_TO=""
TIME_FILTERS=false   # Indicator for specific time filters
TAIL_LINES="100"     # Default to the last 100 lines

# ---- Config ----

# Prefer explicit NEUROSIMO_ROOT; otherwise infer from script location.
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
NEUROSIMO_ROOT="${NEUROSIMO_ROOT:-$SCRIPT_DIR}"
COMPOSE_FILE="${NEUROSIMO_ROOT}/docker-compose.yml"

# The journald unit that streams compose logs.
LOG_UNIT="${LOG_UNIT:-neurosimo-logs.service}"

# Match systemd unit/project naming.
export COMPOSE_PROJECT_NAME="${COMPOSE_PROJECT_NAME:-neurosimo}"

# ---- Helpers ----

function die() { echo "ERROR: $*" >&2; exit 1; }

function ensure_compose_file() {
    [[ -f "$COMPOSE_FILE" ]] || die "Compose file not found: $COMPOSE_FILE (set NEUROSIMO_ROOT or place script in repo root)"
}

# List services known to compose. This is better than "running containers" because logs can be useful even if exited.
function get_services() {
    ensure_compose_file
    docker compose -f "$COMPOSE_FILE" config --services 2>/dev/null | sort
}

function print_available_containers() {
    local services
    services="$(get_services || true)"
    if [[ -z "${services:-}" ]]; then
        echo "ERROR: No compose services found (is Docker running? is compose file valid?)."
    else
        echo "Available services:"
        echo ""
        echo "$services" | sed 's/^/  - /'
        echo ""
    fi
}

function print_usage() {
    echo ""
    echo "Usage examples:"
    echo "./log [service] -n 1000                 # Show last 1000 lines (default 100)"
    echo "./log [service] --save output.log       # Save logs to a file"
    echo "./log [service] --last-hour             # Logs from last hour"
    echo "./log [service] --from \"YYYY-MM-DD HH:MM:SS\" --to \"YYYY-MM-DD HH:MM:SS\""
    echo ""
    echo "If no service is provided, logs from all services will be shown (via journald follower: ${LOG_UNIT})."
    echo ""
    print_available_containers
    exit 0
}

# ---- Parse args ----
while [[ "$#" -gt 0 ]]; do
    case $1 in
        --from) FROM=$2; FOLLOW=false; TIME_FILTERS=true; shift 2;;
        --to) TO=$2; FOLLOW=false; TIME_FILTERS=true; shift 2;;
        --last-hour) FROM="1 hour ago"; FOLLOW=false; TIME_FILTERS=true; shift;;
        --last-day) FROM="1 day ago"; FOLLOW=false; TIME_FILTERS=true; shift;;
        --last-minute) FROM="1 minute ago"; FOLLOW=false; TIME_FILTERS=true; shift;;
        --save) SAVE_TO=$2; shift 2;;
        --follow|-f) FOLLOW=true; shift;;
        -n) TAIL_LINES=$2; shift 2;;
        --help|-h) print_usage;;
        *)
            if [[ -z "$CONTAINER_NAME" ]]; then
                CONTAINER_NAME=$1
            else
                die "Unknown parameter passed: $1"
            fi
            shift;;
    esac
done

# Validate service name if provided
if [[ -n "$CONTAINER_NAME" ]]; then
    services="$(get_services)"
    if ! echo "$services" | grep -qx "$CONTAINER_NAME"; then
        echo "Error: Service '$CONTAINER_NAME' not found in compose config."
        echo ""
        print_available_containers
        exit 1
    fi
fi

# Check if save file exists and prompt for overwrite
if [[ -n "${SAVE_TO}" && -f "${SAVE_TO}" ]]; then
    read -p "$SAVE_TO exists. Overwrite? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Operation cancelled."
        exit 1
    fi
fi

# ---- Formatting pipeline ----

COLOR_RESET=$(echo -e '\033[0m')
COLOR_CONTAINER=$(echo -e '\033[0;36m')
COLOR_TIMESTAMP=$(echo -e '\033[0;33m')
COLOR_DEFAULT=$(echo -e '\033[0;37m')
COLOR_HIGH_INTENSITY_WHITE=$(echo -e '\033[0;97m')

NON_BREAKING_SPACE=$(echo -e '\xC2\xA0')

REMOVE_SUFFIX_CMD="sed -E \"s/^([[:alnum:]_-]+)-1(\s+\|)/${COLOR_CONTAINER}\1\2${COLOR_DEFAULT}/\" --unbuffered"
FORMAT_TIMESTAMP_CMD="sed -E \"s/([0-9]{4}-[0-9]{2}-[0-9]{2})T([0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{3})\+[0-9]{2}:[0-9]{2}/${COLOR_TIMESTAMP}\1 \2${COLOR_DEFAULT}${NON_BREAKING_SPACE}${NON_BREAKING_SPACE}${NON_BREAKING_SPACE}/g\" --unbuffered"
CLEAN_LABELS_CMD="sed -E 's/\\[([[:alnum:]_-]+)-[0-9]+\\]/[\\1]/g' --unbuffered"
REMOVE_ROS_TIMESTAMPS_CMD="sed -E 's/\\[[0-9]+\\.[0-9]+\\]\\s+//g' --unbuffered"
PAD_MESSAGE_TYPES_CMD="sed -E 's/\\[(INFO|WARN)\\]/[\\1 ]/g' --unbuffered"
HIGHLIGHT_AFTER_THIRD_COLON_CMD="sed \"s/\\(:[^:]*:[^:]*:\\)\\(.*\\)$/\\1${COLOR_HIGH_INTENSITY_WHITE}\\2/\" --unbuffered"
ADD_DEFAULT_COLOR_CMD="sed \"s/^/${COLOR_DEFAULT}/\" --unbuffered"
RESET_COLOR_CMD="sed \"s/$/${COLOR_RESET}/\" --unbuffered"

FORMAT_CMD="$REMOVE_SUFFIX_CMD | $FORMAT_TIMESTAMP_CMD | $CLEAN_LABELS_CMD | $REMOVE_ROS_TIMESTAMPS_CMD | $PAD_MESSAGE_TYPES_CMD | $HIGHLIGHT_AFTER_THIRD_COLON_CMD | $ADD_DEFAULT_COLOR_CMD | $RESET_COLOR_CMD"

# Filter out known-noise
NOISE_FILTER="grep -v 'Failed to parse type hash'"

# ---- Logging logic ----
# Rationale:
# - For "single service + tail lines + no time filters": docker compose logs is best (precise tail).
# - For time filters and "all services": journald from neurosimo-logs.service is best.

if [[ -n "$CONTAINER_NAME" && "$TIME_FILTERS" == false ]]; then
    # Compose logs path (single service)
    ensure_compose_file
    CMD="/usr/bin/docker compose -f \"$COMPOSE_FILE\" logs --timestamps --tail \"$TAIL_LINES\""
    [[ "$FOLLOW" == true ]] && CMD="$CMD -f"
    CMD="$CMD \"$CONTAINER_NAME\""

    # Convert UTC->local if available; fall back if the helper isn't installed.
    if command -v docker-compose-logs-localtime >/dev/null 2>&1; then
        CMD="$CMD | docker-compose-logs-localtime"
    fi

    CMD="$CMD | $FORMAT_CMD | $NOISE_FILTER"
    [[ -n "$SAVE_TO" ]] && CMD="$CMD | tee \"$SAVE_TO\""

    eval "$CMD"
else
    # Journald path (aggregated logs from the follower service)
    CMD="journalctl -u \"$LOG_UNIT\" -b"

    if [[ "$TIME_FILTERS" == false ]]; then
        CMD="$CMD --lines \"$TAIL_LINES\""
    fi
    [[ -n "$FROM" ]] && CMD="$CMD --since \"$FROM\""
    [[ -n "$TO" ]] && CMD="$CMD --until \"$TO\""
    [[ "$FOLLOW" == true ]] && CMD="$CMD -f"

    # If service name is provided, filter by the prefix compose uses in its logs output.
    # Compose logs output typically includes "<service>-1  | ..." or "<service>-1 | ...".
    if [[ -n "$CONTAINER_NAME" ]]; then
        CMD="$CMD | grep -E \"^${CONTAINER_NAME}-[0-9]+\\s+\\|\""
    fi

    CMD="$CMD | $FORMAT_CMD | $NOISE_FILTER"
    [[ -n "$SAVE_TO" ]] && CMD="$CMD | tee \"$SAVE_TO\""

    eval "$CMD"
fi
