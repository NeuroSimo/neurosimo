---
- name: Setup an environment for NeuroSimo
  hosts: localhost
  connection: local
  become: yes

  vars:
    # The user that runs the playbook.
    target_user: "{{ lookup('env', 'USER') }}"
    target_home: "/home/{{ target_user }}"

    # The repository root.
    repo_root: "{{ playbook_dir | dirname }}"

    # Location of user projects.
    projects_root: "{{ target_home }}/projects"

    # ROS distro
    ros_distro: "iron"

  tasks:
    ########################################################################
    # Prerequisites
    #
    # ROS2 repository key expires regularly. If not refreshed, apt update
    # fails with an EXPKEYSIG error. Ensure the current key and repo config
    # are always present.
    #
    ########################################################################
    - name: Ensure ROS2 apt key is up to date
      ansible.builtin.get_url:
        url: https://raw.githubusercontent.com/ros/rosdistro/master/ros.key
        dest: /usr/share/keyrings/ros-archive-keyring.gpg
        mode: '0644'

    - name: Ensure ROS2 apt source is configured
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu {{ ansible_lsb.codename }} main"
        state: present
        filename: ros2-latest

    ########################################################################
    # Update apt cache
    ########################################################################
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600 # in seconds

    ########################################################################
    # Install Node.js 18 LTS from NodeSource
    ########################################################################
    - name: Remove old Node.js packages
      apt:
        name:
          - nodejs
          - libnode-dev
          - libnode72
        state: absent
        purge: yes
      ignore_errors: yes

    - name: Check if NodeSource repository is configured
      stat:
        path: /etc/apt/sources.list.d/nodesource.list
      register: nodesource_repo

    - name: Download and run NodeSource setup script
      shell: curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
      when: not nodesource_repo.stat.exists

    - name: Install Node.js 18 from NodeSource
      apt:
        name: nodejs
        state: present
        update_cache: yes

    ########################################################################
    # Install extra packages (net-tools, Wireshark, etc.)
    ########################################################################
    - name: Install other tools, e.g., for troubleshooting
      apt:
        name:
          - net-tools
          - wireshark
          - wmctrl
          - python3-pip
        state: present

    ########################################################################
    # Kernel tools
    #
    # Install extra kernel tools for monitoring/troubleshooting.
    # RT variants (linux-*-realtime) are not always available, so
    # only install if they are.
    ########################################################################
    - name: Gather kernel tool candidates
      set_fact:
        kernel_tool_candidates:
          - linux-tools-generic
          - linux-cloud-tools-generic
          - linux-tools-realtime
          - linux-cloud-tools-realtime
          - "linux-tools-{{ ansible_kernel }}"
          - "linux-cloud-tools-{{ ansible_kernel }}"

    - name: Check which kernel tool packages are available
      command: "apt-cache show {{ item }}"
      register: pkg_info
      changed_when: false
      failed_when: false
      loop: "{{ kernel_tool_candidates }}"

    - name: Install available kernel tool packages
      apt:
        name: "{{ item.item }}"
        state: present
      loop: "{{ pkg_info.results }}"
      when: item.rc == 0

    ########################################################################
    # Copy systemd service files & enable
    ########################################################################
    - name: Detect DISPLAY for target user
      shell: echo $DISPLAY
      become: no
      register: user_display
      changed_when: false

    - name: Set display_number variable
      set_fact:
        display_number: "{{ user_display.stdout | default(':0') }}"

    - name: Copy NeuroSimo service
      template:
        src: files/neurosimo.service.j2
        dest: /etc/systemd/system/neurosimo.service
        owner: root
        group: root
        mode: "0644"

    - name: Copy NeuroSimo log follower service
      template:
        src: files/neurosimo-logs.service.j2
        dest: /etc/systemd/system/neurosimo-logs.service
        owner: root
        group: root
        mode: "0644"

    - name: Copy set-cpupower.service
      copy:
        src: files/set-cpupower.service
        dest: /etc/systemd/system/set-cpupower.service
        owner: root
        group: root
        mode: "0644"

    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes

    - name: Enable NeuroSimo services
      systemd:
        name: "{{ item }}"
        enabled: yes
      loop:
        - neurosimo.service
        - neurosimo-logs.service

    - name: Enable set-cpupower.service
      systemd:
        name: set-cpupower.service
        enabled: yes

    - name: Restart set-cpupower.service
      systemd:
        name: set-cpupower.service
        state: restarted

    ########################################################################
    # Copy sysctl configuration
    ########################################################################
    - name: Copy 10-net-buffer-size.conf
      copy:
        src: files/10-net-buffer-size.conf
        dest: /etc/sysctl.d/10-net-buffer-size.conf
        owner: root
        group: root
        mode: "0644"

    - name: Reload sysctl
      shell: sysctl --system

    ########################################################################
    # Configure a cron job to clean old ROS logs
    ########################################################################
    - name: Ensure cron job to clean old ROS logs
      cron:
        name: "Clean ROS logs older than 7 days"
        minute: "0"
        hour: "0"
        user: "{{ target_user }}"
        job: "find {{ target_home }}/.ros/log -type f -mtime +7 -exec rm {} \\;"

    ########################################################################
    # Configure PulseAudio over TCP
    ########################################################################
    - name: Append module-native-protocol-tcp to /etc/pulse/default.pa
      lineinfile:
        path: /etc/pulse/default.pa
        line: "load-module module-native-protocol-tcp auth-ip-acl=127.0.0.1;172.17.0.0/16 auth-anonymous=1"
        state: present

    ########################################################################
    # Give the user passwordless sudo for specific commands
    ########################################################################
    - name: Allow user to restart NeuroSimo without sudo password
      lineinfile:
        path: /etc/sudoers.d/restart_containers
        line: "{{ target_user }} ALL=(ALL) NOPASSWD: /bin/systemctl restart neurosimo"
        create: yes
        mode: "0440"

    - name: Allow user to run the log script without sudo password
      lineinfile:
        path: /etc/sudoers.d/log_script
        line: "{{ target_user }} ALL=(ALL) NOPASSWD: {{ repo_root }}/scripts/log"
        create: yes
        mode: "0440"

    ########################################################################
    # Create a projects directory for the user
    ########################################################################
    - name: Create projects directory
      file:
        path: "{{ projects_root }}"
        state: directory
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: "0755"

    ########################################################################
    # Create .bash_env from scratch
    ########################################################################
    - name: Create fresh .bash_env file
      copy:
        dest: "{{ target_home }}/.bash_env"
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: "0644"
        content: |
          # NeuroSimo environment configuration
          # This file is managed by Ansible - do not edit manually

          # Add NeuroSimo scripts to PATH
          export PATH=$PATH:{{ repo_root }}/scripts/

          # NeuroSimo root directory
          export NEUROSIMO_ROOT={{ repo_root }}

          # Projects directory
          export PROJECTS_ROOT={{ projects_root }}

          # ROS2 middleware configuration
          export RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
          export CYCLONEDDS_URI=file://$NEUROSIMO_ROOT/ros2_ws/config/cyclonedds.xml

          # Source ROS2 base installation
          source /opt/ros/{{ ros_distro }}/setup.bash

          # Source NeuroSimo workspace if it exists
          if [ -f {{ repo_root }}/ros2_ws/install/setup.bash ]; then
              source {{ repo_root }}/ros2_ws/install/setup.bash
          fi

          # Source .env file if it exists
          if [ -f {{ repo_root }}/.env ]; then
              set -a
              source {{ repo_root }}/.env
              set +a
          fi

    - name: Ensure .bash_env is sourced in .bashrc
      lineinfile:
        dest: "{{ target_home }}/.bashrc"
        line: "source {{ target_home }}/.bash_env"
        state: present
        insertafter: EOF

    ########################################################################
    # Set up the environment
    ########################################################################
    - name: Check if .env exists
      stat:
        path: "{{ repo_root }}/.env"
      register: env_file_status

    - name: Copy .env.example to .env if .env does not exist
      copy:
        src: files/.env.example
        dest: "{{ repo_root }}/.env"
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: "0644"
      when: not env_file_status.stat.exists
